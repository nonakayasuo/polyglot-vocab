// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client"
  output          = "./generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector] // pgvector for embeddings
}

model VocabularyWord {
  id                 String   @id @default(cuid())
  word               String
  pronunciation      String   @default("")
  category           String   @default("Noun")
  meaning            String   @default("")
  example            String   @default("")
  exampleTranslation String   @default("") // 例文の日本語訳
  note               String   @default("")
  language           String   @default("english")
  check1             Boolean  @default(false)
  check2             Boolean  @default(false)
  check3             Boolean  @default(false)
  displayOrder       Int      @default(0) // 表示順序
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // レジスター情報（v2.0 新規）
  register           String   @default("NEUTRAL") // FORMAL, NEUTRAL, CASUAL, SLANG, TABOO
  tpoAdvice          String   @default("") // 使用場面アドバイス
  synonyms           String   @default("[]") // JSON: レジスター違いの類語

  // 単語コンテキスト（どの記事から学んだか）
  contexts WordContext[]

  @@index([language])
  @@index([createdAt])
  @@index([displayOrder])
  @@index([register])
}

// キャッシュされたニュース記事

model Article {
  id          String   @id @default(cuid())
  externalId  String   @unique // News APIからのID（URLハッシュ等）
  title       String
  description String   @default("")
  content     String   @default("")
  url         String
  imageUrl    String?
  source      String // ニュースソース名
  author      String?
  language    String   @default("en")
  category    String?
  publishedAt DateTime
  cachedAt    DateTime @default(now())

  // v2.0 新規フィールド
  contentType    String   @default("news") // news, entertainment, gossip, sports, tech, culture
  cefrLevel      String?  // 記事のCEFRレベル
  slangLevel     Float    @default(0) // スラング含有度 0-1
  isAdultContent Boolean  @default(false) // 18+コンテンツフラグ
  tags           String   @default("[]") // JSON: タグ配列

  // リレーション
  readingHistory ReadingHistory[]
  wordContexts   WordContext[]

  @@index([language])
  @@index([source])
  @@index([publishedAt])
  @@index([cachedAt])
  @@index([contentType])
  @@index([isAdultContent])
}

// 読書履歴

model ReadingHistory {
  id           String   @id @default(cuid())
  articleId    String
  article      Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  readAt       DateTime @default(now())
  wordsLearned Int      @default(0) // この記事から学んだ単語数
  readTime     Int? // 読書時間（秒）

  @@index([articleId])
  @@index([readAt])
}

// 単語と記事のコンテキスト（どの記事のどの文から学んだか）

model WordContext {
  id            String         @id @default(cuid())
  wordId        String
  word          VocabularyWord @relation(fields: [wordId], references: [id], onDelete: Cascade)
  articleId     String
  article       Article        @relation(fields: [articleId], references: [id], onDelete: Cascade)
  sentence      String // 単語が含まれる文
  sentenceIndex Int? // 記事内での文の位置
  createdAt     DateTime       @default(now())

  @@unique([wordId, articleId])
  @@index([wordId])
  @@index([articleId])
}

// ベクトル埋め込み（pgvector使用、意味検索用）
model WordEmbedding {
  id        String                   @id @default(cuid())
  word      String                   @unique
  language  String                   @default("english")
  embedding Unsupported("vector(1536)") // OpenAI text-embedding-3-small
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt

  @@index([language])
  @@map("word_embedding")
}

// 記事埋め込み（類似記事検索用）
model ArticleEmbedding {
  id        String                   @id @default(cuid())
  articleId String                   @unique
  embedding Unsupported("vector(1536)")
  createdAt DateTime                 @default(now())

  @@map("article_embedding")
}

model User {
  id               String    @id
  name             String
  email            String
  emailVerified    Boolean   @default(false)
  image            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  cefrLevel        String?
  learningLanguage String?   @default("english")
  nativeLanguage   String?   @default("japanese")
  sessions         Session[]
  accounts         Account[]

  // レベル判定関連
  levelAssessments LevelAssessment[]
  slangLevel       String?   // スラング理解度レベル: NONE, BASIC, INTERMEDIATE, ADVANCED, NATIVE

  // ゲーミフィケーション関連
  streak           UserStreak?
  achievements     UserAchievement[]
  weeklyXp         Int       @default(0) // 週間XP（ランキング用）
  totalXp          Int       @default(0) // 累計XP

  // コンテンツ設定関連
  contentSettings  UserContentSettings?
  
  // 通知設定（JSON形式）
  notificationSettings String?

  @@unique([email])
  @@map("user")
}

// ========================================
// ユーザーコンテンツ設定（v2.0 新規）
// ========================================

// ユーザーの18+コンテンツ設定
model UserContentSettings {
  id                   String   @id @default(cuid())
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 年齢確認
  dateOfBirth          DateTime?
  ageVerified          Boolean  @default(false)
  ageVerifiedAt        DateTime?
  
  // 18+コンテンツ設定
  adultContentEnabled  Boolean  @default(false)
  
  // コンテンツフィルター
  preferredCategories  String   @default("[]") // JSON: ["news", "entertainment", "sports"]
  blockedCategories    String   @default("[]") // JSON: カテゴリをブロック
  
  // レジスター設定
  showSlang            Boolean  @default(true)  // スラング表示
  showTaboo            Boolean  @default(false) // タブー表現表示（18+必須）
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
  @@map("user_content_settings")
}

// ========================================
// レベル判定システム
// ========================================

// レベル判定結果
model LevelAssessment {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  language        String   @default("english") // 判定対象言語
  cefrLevel       String   // A1, A2, B1, B2, C1, C2
  vocabularyScore Float    // 語彙スコア (0-100)
  readingScore    Float    // 読解スコア (0-100)
  overallScore    Float    // 総合スコア (0-100)
  strengths       String   @default("") // JSON: 強み分析
  weaknesses      String   @default("") // JSON: 弱み分析
  recommendations String   @default("") // JSON: 学習推奨
  completedAt     DateTime @default(now())

  // スラング理解度（v2.0 新規）
  slangScore      Float?   // スラング理解度スコア (0-100)
  slangLevel      String?  // NONE, BASIC, INTERMEDIATE, ADVANCED, NATIVE
  registerScore   Float?   // レジスター識別スコア (0-100)

  // テスト詳細
  vocabularyResponses VocabularyTestResponse[]
  readingResponses    ReadingTestResponse[]
  slangResponses      SlangTestResponse[]

  @@index([userId])
  @@index([language])
  @@index([completedAt])
  @@map("level_assessment")
}

// 語彙テスト問題
model VocabularyQuestion {
  id           String   @id @default(cuid())
  language     String   @default("english")
  cefrLevel    String   // A1, A2, B1, B2, C1, C2
  questionType String   // "meaning", "synonym", "antonym", "fill_blank"
  word         String
  question     String   // 問題文
  options      String   // JSON: 選択肢配列
  correctIndex Int      // 正解のインデックス
  explanation  String   @default("") // 解説
  difficulty   Float    @default(0.5) // IRT難易度パラメータ
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  responses VocabularyTestResponse[]

  @@index([language, cefrLevel])
  @@index([isActive])
  @@map("vocabulary_question")
}

// 語彙テスト回答
model VocabularyTestResponse {
  id           String             @id @default(cuid())
  assessmentId String
  assessment   LevelAssessment    @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  questionId   String
  question     VocabularyQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedIdx  Int                // 選択した回答のインデックス
  isCorrect    Boolean
  responseTime Int?               // 回答時間（ミリ秒）
  createdAt    DateTime           @default(now())

  @@index([assessmentId])
  @@index([questionId])
  @@map("vocabulary_test_response")
}

// 読解テスト問題（記事ベース）
model ReadingQuestion {
  id           String   @id @default(cuid())
  language     String   @default("english")
  cefrLevel    String   // A1, A2, B1, B2, C1, C2
  title        String   // 記事タイトル
  content      String   // 記事本文
  wordCount    Int      // 単語数
  questions    String   // JSON: 理解度確認問題の配列
  difficulty   Float    @default(0.5) // IRT難易度パラメータ
  source       String?  // ニュースソース
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  responses ReadingTestResponse[]

  @@index([language, cefrLevel])
  @@index([isActive])
  @@map("reading_question")
}

// 読解テスト回答
model ReadingTestResponse {
  id           String          @id @default(cuid())
  assessmentId String
  assessment   LevelAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  questionId   String
  question     ReadingQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answers      String          // JSON: 各問題への回答
  correctCount Int             // 正解数
  totalCount   Int             // 問題数
  readingTime  Int?            // 読解時間（秒）
  createdAt    DateTime        @default(now())

  @@index([assessmentId])
  @@index([questionId])
  @@map("reading_test_response")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// ========================================
// ゲーミフィケーションシステム
// ========================================

// ユーザーのストリーク（連続学習日数）
model UserStreak {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentStreak Int      @default(0)  // 現在の連続日数
  longestStreak Int      @default(0)  // 最長連続日数
  lastActiveAt  DateTime @default(now()) // 最後のアクティビティ日時
  streakFreezes Int      @default(0)  // ストリークフリーズ残数
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([currentStreak])
  @@map("user_streak")
}

// 達成可能なバッジ/実績の定義
model Achievement {
  id           String   @id @default(cuid())
  code         String   @unique // "first_word", "streak_7", "vocabulary_100" など
  name         String   // 表示名
  nameJa       String   // 日本語名
  description  String   // 説明
  descriptionJa String  // 日本語説明
  icon         String   // 絵文字またはアイコン名
  category     String   // "streak", "vocabulary", "reading", "milestone"
  requirement  Int      // 達成に必要な数値
  xpReward     Int      @default(0) // 獲得XP
  rarity       String   @default("common") // "common", "rare", "epic", "legendary"
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  userAchievements UserAchievement[]

  @@index([category])
  @@index([isActive])
  @@map("achievement")
}

// ユーザーが獲得したバッジ
model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  earnedAt      DateTime    @default(now())
  progress      Int         @default(0) // 進捗（達成前）

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@index([earnedAt])
  @@map("user_achievement")
}

// 学習アクティビティログ（XP計算用）
model LearningActivity {
  id          String   @id @default(cuid())
  userId      String?  // 匿名ユーザーも対応
  activityType String  // "word_added", "word_mastered", "article_read", "quiz_completed"
  xpEarned    Int      @default(0)
  metadata    String   @default("{}") // JSON: 追加情報
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([activityType])
  @@index([createdAt])
  @@map("learning_activity")
}

// ========================================
// スラング・レジスター学習システム（v2.0 新規）
// ========================================

// 語彙レジスター（フォーマル度）
enum Register {
  FORMAL      // フォーマル（ビジネス、学術）
  NEUTRAL     // ニュートラル（日常会話）
  CASUAL      // カジュアル（友人との会話）
  SLANG       // スラング（SNS、若者言葉）
  TABOO       // タブー（18+、使用注意）
}

// スラング辞書
model SlangDictionary {
  id            String     @id @default(cuid())
  word          String
  language      String     @default("english")
  meaning       String     // 意味
  meaningJa     String     @default("") // 日本語訳
  register      Register   @default(SLANG)
  usageContext  String     @default("[]") // JSON: 使用場面 ["SNS", "友人", "若者"]
  examples      String     @default("[]") // JSON: 例文配列
  tpoAdvice     String     @default("") // TPO（時・場所・場合）アドバイス
  synonyms      String     @default("[]") // JSON: 類語配列（レジスター違いの同義語）
  popularity    Float      @default(0.5) // 人気度 0-1
  isActive      Boolean    @default(true)
  source        String?    // 出典（Urban Dictionary等）
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@unique([word, language])
  @@index([language])
  @@index([register])
  @@index([popularity])
  @@map("slang_dictionary")
}

// SNSバズワード（リアルタイムトレンド）
model BuzzWord {
  id           String   @id @default(cuid())
  word         String
  language     String   @default("english")
  meaning      String
  meaningJa    String   @default("") // 日本語訳
  source       String   // TWITTER, REDDIT, TIKTOK
  trendScore   Float    @default(0) // トレンドスコア 0-100
  category     String?  // カテゴリ（褒め言葉、強調、ミーム等）
  examples     String   @default("[]") // JSON: 使用例
  firstSeen    DateTime @default(now())
  lastSeen     DateTime @default(now())
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([word, language, source])
  @@index([language])
  @@index([source])
  @@index([trendScore])
  @@index([lastSeen])
  @@map("buzz_word")
}

// スラング理解度テスト問題
model SlangQuestion {
  id           String   @id @default(cuid())
  language     String   @default("english")
  difficulty   String   // BASIC, INTERMEDIATE, ADVANCED, NATIVE
  questionType String   // "meaning", "context", "register", "tpo"
  word         String
  question     String   // 問題文
  options      String   // JSON: 選択肢配列
  correctIndex Int      // 正解のインデックス
  explanation  String   @default("") // 解説
  register     Register @default(SLANG)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  responses SlangTestResponse[]

  @@index([language, difficulty])
  @@index([register])
  @@index([isActive])
  @@map("slang_question")
}

// スラングテスト回答
model SlangTestResponse {
  id           String        @id @default(cuid())
  assessmentId String
  assessment   LevelAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  questionId   String
  question     SlangQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedIdx  Int           // 選択した回答のインデックス
  isCorrect    Boolean
  responseTime Int?          // 回答時間（ミリ秒）
  createdAt    DateTime      @default(now())

  @@index([assessmentId])
  @@index([questionId])
  @@map("slang_test_response")
}

// ========================================
// Deep News Integration（v2.0 新規）
// ========================================

// ニュースタイムライン（トピックの時系列変化）
model NewsTimeline {
  id          String   @id @default(cuid())
  topicId     String   @unique // トピック識別子
  topicName   String   // トピック名
  language    String   @default("english")
  articleIds  String   @default("[]") // JSON: 関連記事ID配列（時系列順）
  summary     String   @default("") // AI生成のタイムライン要約
  keywords    String   @default("[]") // JSON: 関連キーワード
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([language])
  @@index([topicName])
  @@map("news_timeline")
}

// 多視点比較（同トピック複数ソース）
model MultiPerspective {
  id          String   @id @default(cuid())
  topicId     String   // トピック識別子
  language    String   @default("english")
  sources     String   @default("[]") // JSON: ソース配列 ["BBC", "CNN", "Al Jazeera"]
  articleIds  String   @default("[]") // JSON: 各ソースの記事ID
  comparison  String   @default("") // AI生成の比較分析
  biasNotes   String   @default("") // バイアス分析メモ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([topicId])
  @@index([language])
  @@map("multi_perspective")
}

// 背景コンテキスト（AI生成）
model BackgroundContext {
  id          String   @id @default(cuid())
  articleId   String   @unique
  language    String   @default("english")
  historical  String   @default("") // 歴史的背景
  cultural    String   @default("") // 文化的背景
  political   String   @default("") // 政治的背景
  keyTerms    String   @default("[]") // JSON: 重要用語解説
  relatedTopics String @default("[]") // JSON: 関連トピック
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([articleId])
  @@map("background_context")
}

// ========================================
// Phase 4: コミュニティ機能（新規）
// ========================================

// 学習グループ
model LearningGroup {
  id          String   @id @default(cuid())
  name        String
  description String   @default("")
  imageUrl    String?
  ownerId     String
  isPrivate   Boolean  @default(false)
  maxMembers  Int      @default(50)
  language    String   @default("english")
  level       String?  // 推奨CEFRレベル
  tags        String   @default("[]") // JSON: グループタグ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     GroupMember[]
  discussions GroupDiscussion[]

  @@index([ownerId])
  @@index([language])
  @@index([isPrivate])
  @@map("learning_group")
}

// グループメンバー
model GroupMember {
  id        String   @id @default(cuid())
  groupId   String
  group     LearningGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId    String
  role      String   @default("member") // owner, admin, member
  joinedAt  DateTime @default(now())
  
  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("group_member")
}

// グループディスカッション（記事ベース）
model GroupDiscussion {
  id        String   @id @default(cuid())
  groupId   String
  group     LearningGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  articleId String?  // 記事に関連したディスカッション
  title     String
  content   String
  authorId  String
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  comments DiscussionComment[]

  @@index([groupId])
  @@index([articleId])
  @@index([authorId])
  @@map("group_discussion")
}

// 記事コメント（ディスカッション）
model ArticleComment {
  id          String   @id @default(cuid())
  articleId   String
  userId      String
  content     String
  parentId    String?  // 返信の場合、親コメントID
  likesCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 自己参照リレーション
  parent      ArticleComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     ArticleComment[] @relation("CommentReplies")

  @@index([articleId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@map("article_comment")
}

// ディスカッションコメント
model DiscussionComment {
  id           String   @id @default(cuid())
  discussionId String
  discussion   GroupDiscussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  userId       String
  content      String
  parentId     String?
  likesCount   Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  parent       DiscussionComment?  @relation("DiscussionReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies      DiscussionComment[] @relation("DiscussionReplies")

  @@index([discussionId])
  @@index([userId])
  @@index([parentId])
  @@map("discussion_comment")
}

// ユーザー投稿スラング辞書
model UserSlangEntry {
  id          String   @id @default(cuid())
  userId      String
  word        String
  language    String   @default("english")
  meaning     String
  meaningJa   String   @default("")
  example     String   @default("")
  register    String   @default("SLANG") // CASUAL, SLANG, TABOO
  source      String?  // どこで聞いた/見た
  upvotes     Int      @default(0)
  downvotes   Int      @default(0)
  isApproved  Boolean  @default(false) // モデレーション済み
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  votes       SlangEntryVote[]

  @@unique([word, language, userId])
  @@index([language])
  @@index([userId])
  @@index([isApproved])
  @@index([upvotes])
  @@map("user_slang_entry")
}

// スラングエントリーへの投票
model SlangEntryVote {
  id        String   @id @default(cuid())
  entryId   String
  entry     UserSlangEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  userId    String
  voteType  String   // upvote, downvote
  createdAt DateTime @default(now())

  @@unique([entryId, userId])
  @@index([entryId])
  @@index([userId])
  @@map("slang_entry_vote")
}

// 通知
model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // comment_reply, group_invite, achievement, streak_reminder
  title     String
  body      String
  data      String   @default("{}") // JSON: 追加データ
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notification")
}

// アクティビティフィード
model ActivityFeed {
  id           String   @id @default(cuid())
  userId       String
  activityType String   // word_learned, article_read, achievement_earned, streak_milestone, slang_posted
  title        String
  description  String   @default("")
  metadata     String   @default("{}") // JSON: 追加データ
  isPublic     Boolean  @default(true)
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([activityType])
  @@index([createdAt])
  @@index([isPublic])
  @@map("activity_feed")
}
